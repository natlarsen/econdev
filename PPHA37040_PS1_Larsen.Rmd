---
title: 'PPHA 37040 Problem Set 1: Structural Transformation Training; Analysis of the Philippines'
author: "Nat Larsen, nclarsen"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---
```{r}
# Install Necessary Packages

# Install dplyr
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}

# Install ggplot2
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}

# Install dendextend
if (!requireNamespace("dendextend", quietly = TRUE)) {
  install.packages("dendextend")
}

# Install strucchange
if (!requireNamespace("strucchange", quietly = TRUE)) {
  install.packages("strucchange")
}

# Install haven package to read the .dta file
if (!requireNamespace("haven", quietly = TRUE)) {
  install.packages("haven")
}

# Install tidyr
if (!requireNamespace("tidyr", quietly = TRUE)) {
  install.packages("tidyr")
}

# Install scales
if (!requireNamespace("scales", quietly = TRUE)) {
  install.packages("scales")
}

# Install ggrepel
if (!requireNamespace("ggrepel", quietly = TRUE)) {
  install.packages("ggrepel")
}
```

```{r setup, include=FALSE}
# Load Necessary Packages
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(dendextend)
library(strucchange)
library(haven)
library(tidyr)
library(scales)
library(ggrepel)
```

### Data Preparation

## Load and Prepare Data
```{r}
# Read the .dta file
# .dta file must be in the same working directory as this .Rmd
data <- read_dta("/Users/natlarsen/Downloads/Master Data/glmacro_master_alldata.dta")
```

```{r}
# Select the Philippines as the country
country <- "Philippines"

# Add a dummy column for a chosen country
data <- data %>%
  mutate(dummy_chosen_country = ifelse(wb_countryname == country, 1, 0))
```

# Question 1: History of Population and GDP (10 points)
```{r}
# Filter the dataset and plot the GDP
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_ny_gdp_mktp_cd)) +
  geom_line(color = "cadetblue") +
  labs(title = paste("Gross Domestic Product,", country),
       y = "GDP GDP (current US$)",
       x = "Year") +
  theme_minimal()

```

```{r}
# Plot Population Time Series
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_sp_pop_totl)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Population in", country),
       y = "Population (Millions)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot GDP per capita Time Series
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_ny_gdp_pcap_cd)) +
  geom_line(color = "cadetblue3") +
  labs(title = paste("GDP per Capita in", country),
       y = "GDP per capita (current US$)",
       x = "Year") +
  theme_minimal()

```

```{r}
# Plot Real GDP Growth
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_ny_gdp_mktp_kd_zg)) +
  geom_line(color = "cadetblue") +
  labs(title = paste("GDP Growth in", country),
       y = "GDP Growth, annual (%)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot Population Growth
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_sp_pop_grow)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Population Growth in", country),
       y = "Population Growth, annual (%)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot GDP Per Capita Growth
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_ny_gdp_pcap_kd_zg)) +
  geom_line(color = "cadetblue3") +
  labs(title = paste("GDP per Capita Growth in", country),
       y = "GDP per Capita Growth (%)",
       x = "Year") +
  theme_minimal()
```
Between 1990 and 2023, the Philippines; *Real GDP* increased from 1 to 4 billion USD; *population* consistently increased in population from 6 million to over 100 million; and *GDP per capita* increased, although less dramatically than real GDP, from under 1000 to around 3500 USD. 

*Real GDP Growth* and *Real GDP per capita growth* were volatile, rising and then falling dramatically around 2000, 2010, and 2020, coinciding with the 1990s Asian Financial Crisis, the 2008 Global Financial Crisis, and the 2020 Pandemic. While the population is growing, the rate of population growth is declining—after peaking around 1997, population growth shrunk from nearly 2.5% to current levels under 1.5% annually.

While both real GDP and population are growing, the Philippines experienced more rapid economic growth than population growth. This positive real GDP per capita growth may suggest improvements in living stands; however, its volatility reveals vulnerabilities to external shocks. 
 
# Question 2: Demographic Transition (10 points)
```{r}
# Fertility Rates Time Series
ggplot(data %>% filter(wb_countryname == country & !is.na(wdi_sp_dyn_tfrt_in)),
       aes(x = year, y = wdi_sp_dyn_tfrt_in)) +
  geom_line(color = "cadetblue") +
  labs(title = paste("Total Fertility Rates in", country),
       y = "Fertility Rate (Total)",
       x = "Year") +
  theme_minimal()
```
```{r}
# Mortality Rates Time Series
ggplot(data %>% filter(wb_countryname == country & !is.na(qog_who_mrt)),
       aes(x = year, y = qog_who_mrt)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Mortality Rates in", country),
       y = "Adult Mortality Rate, Total (per 1000 population)",
       x = "Year") +
  theme_minimal()
```
```{r}
# Life Expectancy Time Series
ggplot(data %>% filter(wb_countryname == country & !is.na(wdi_sp_dyn_le00_in)),
       aes(x = year, y = wdi_sp_dyn_le00_in)) +
  geom_line(color = "cadetblue3") +
  labs(title = paste("Life Expectancy in", country),
       y = "Life Expectancy, Total (Years)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot Education Levels (Primary, Secondary, Tertiary)
ggplot(data %>% filter(wb_countryname == country & year >= 1970 & year <= 2023),
       aes(x = year)) +
  geom_line(aes(y = wdi_se_prm_enrr, color = "Primary Enrollment")) +
  geom_line(aes(y = wdi_se_sec_enrr, color = "Secondary Enrollment")) +
  geom_line(aes(y = wdi_se_ter_enrr, color = "Tertiary Enrollment")) +
  scale_color_manual(values = c("Primary Enrollment" = "cadetblue",
                                "Secondary Enrollment" = "cadetblue2",
                                "Tertiary Enrollment" = "cadetblue3")) +
  labs(title = paste("Education Enrollment Levels in", country),
       y = "Enrollment (% Gross)",
       x = "Year",
       color = "Legend") +
  theme_minimal()

```

```{r}
# Additional Plot: Remittances
ggplot(data %>% filter(wb_countryname == country & year >= 2000 & year <= 2023),
       aes(x = year)) +
  geom_line(aes(y = wdi_bm_trf_pwkr_cd_dt), color = "cadetblue3") +
  labs(title = paste("Remittances Paid", country),
       y = "Personal Remittances Paid (in USD)",
       x = "Year") +
  theme_minimal()
```

In the Philippines, *Total Fertility Rates* and *Mortality Rates* are declining, while *Life Expectancy* is increasing. Following the Malthusian to Modern growth trends, a democratic window opened when the gap between the fertility and mortality rate curves was greatest, likely around the peak of fertility in 1960. The current demographics of declining fertility yet rising life expectancy imply a future high dependency, as an older population’s needs may exceed a working population’s production. 

Since the 1970s, *Education Enrollment* has been increasing, revealing greater investment in this growing population—the lagging tertiary enrollment suggests an opportunity to continue expanding education. I was additionally curious about the trends of *Remittances Paid*, which have increased dramatically since 2000—this rising inflow of funds from overseas boosts household income and national economic growth, also revealing the important role of labor migration for the Filipino economy.  

# Question 3: History of Structural Transformation (20 points)
```{r}
# Employment Share in Agriculture
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_sl_agr_empl_zs)) +
  geom_line(color = "cadetblue") +
  labs(title = paste("Share of Employment in Agriculture in", country),
       y = "Share of Employment (%)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot Employment Share in Services
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_sl_srv_empl_zs)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Share of Employment in Services in", country),
       y = "Share of Employment (%)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Plot Employment Share in Manufacturing
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = wdi_sl_ind_empl_zs)) +
  geom_line(color = "cadetblue3") +
  labs(title = paste("Employment in Manufacturing in", country),
       y = "Share of Employment (%)",
       x = "Year") +
  theme_minimal()

```

```{r}
# Convert total GDP from billions to US$
data <- data %>%
  mutate(total_gdp_usd = weo_ngdpd * 1e9)
```

```{r}
# Calculate Shares of GDP
data <- data %>%
  mutate(
    gdp_share_agriculture = (wdi_nv_agr_totl_cd / total_gdp_usd) * 100,
    gdp_share_industry = (wdi_nv_ind_totl_cd / total_gdp_usd) * 100,
    gdp_share_services = (wdi_nv_srv_totl_cd / total_gdp_usd) * 100
  )
```

```{r}
# Plot Share of GDP in Agriculture
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = gdp_share_agriculture)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Share of GDP in Agriculture in", country),
       y = "Share of GDP (%)",
       x = "Year") +
  theme_minimal()
```
```{r}
# Plot Share of GDP in Industry
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = gdp_share_industry)) +
  geom_line(color = "cadetblue3") +
  labs(title = paste("Share of GDP in Industry in", country),
       y = "Share of GDP (%)",
       x = "Year") +
  theme_minimal()
```
```{r}
# Plot Share of GDP in Services
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = gdp_share_services)) +
  geom_line(color = "cadetblue") +
  labs(title = paste("Share of GDP in Services in", country),
       y = "Share of GDP (%)",
       x = "Year") +
  theme_minimal()
```
```{r}
# Reshape GDP shares data of agriculture, industry, and services sector

data_long <- data %>%
  filter(wb_countryname == country & year >= 1990 & year <= 2023) %>%
  select(year, gdp_share_agriculture, gdp_share_industry, gdp_share_services) %>%
  pivot_longer(cols = starts_with("gdp_share"),
               names_to = "Sector",
               values_to = "Share") %>%
  mutate(Sector = recode(Sector,
                         gdp_share_agriculture = "Agriculture",
                         gdp_share_industry = "Industry/manufacturing",
                         gdp_share_services = "Services"))
```

```{r}
# Plot Share of GDP by sector in stacked bar
data_long_filtered <- data_long %>%
  filter(year %% 5 == 0)  # Display data every five years

ggplot(data_long_filtered, aes(x = factor(year), y = Share, fill = Sector)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("Agriculture" = "blue",
                               "Industry/manufacturing" = "gray",
                               "Services" = "brown")) +
  labs(
    title = paste("Share of GDP by Sector in", country),
    x = "Year",
    y = "% of GDP",
    fill = "Sector"
  ) +
  theme_minimal()

```

## Plot Relative Productivity

```{r}
# Calculate relative productivity of agriculture
data <- data %>%
  mutate(
    rel_prod_agriculture = wdi_nv_agr_totl_cd / (wdi_sl_agr_empl_zs / 100)
  )
```

```{r}
# Plot relative productivity in agriculture

ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = rel_prod_agriculture)) +
  geom_line(color = "cadetblue2") +
  labs(title = paste("Relative Productivity of Agriculture in", country),
       y = "Output per Person (US$)",
       x = "Year") +
  theme_minimal()
```

```{r}
# Calculate Relative Productivity for Manufacturing (Industry)
data <- data %>%
  mutate(
    manf_rp = wdi_nv_ind_manf_cd / (wdi_sl_ind_empl_zs / 100)
  )

# Plot Relative Productivity for Manufacturing
ggplot(data %>% filter(wb_countryname == country & year >= 2000 & year <= 2023),
       aes(x = year, y = manf_rp)) +
  geom_line(color = "cadetblue") +
  labs(
    title = paste("Relative Productivity of Manufacturing in", country),
    y = "Relative Productivity (Output per Person)",
    x = "Year"
  ) +
  theme_minimal()

```

```{r}
# Calculate Relative Productivity for Services
data <- data %>%
  mutate(
    manf_rp = wdi_nv_srv_totl_cd / (wdi_sl_srv_empl_zs / 100)
  )

# Plot Relative Productivity for Services
ggplot(data %>% filter(wb_countryname == country & year >= 1990 & year <= 2023),
       aes(x = year, y = manf_rp)) +
  geom_line(color = "darkgreen") +
  labs(
    title = paste("Relative Productivity of Services in", country),
    y = "Relative Productivity (Output per Person)",
    x = "Year"
  ) +
  theme_minimal()
```

Between 1990-2020, the *Share of Employment in Agriculture* shrank to 20% while the *Share of Employment in Services* correspondingly grew to 57%. *Employment in Manufacturing* remained more stable, increasing slightly between 2010-2020 from 15% to 19%. Mirroring these employment trends, the *Share of GDP in Agriculture* decreased to under 10% while the *Share of GDP in Services* skyrocketed to over 60%. The *Share of GDP in Industry* stayed relatively the same, shrinking slightly. Meanwhile, *Relative Productivity* grew across *Agriculture*, *Services*, and *Industry*, revealing efficiency and output improvements per worker across sectors. 

Comparing 1990 and 2020, the Philippines underwent a structural economic shift away from agriculture toward services, revealing an acceleration in services’ employment and GDP share and a deceleration in agriculture’s employment and GDP share; while relative productivity consistently improved across sectors. These graphs do not show any significant instances of volatility. 

# Question 4: Structural Breaks (10 points)

## Filter Data for Chosen Country
```{r}

# Filter data for the chosen country
data_filtered <- data %>%
  filter(wb_countryname == country) %>%
  filter(!is.na(wdi_ny_gdp_pcap_kd_zg)) %>%
  rename(gdp_pc_g = wdi_ny_gdp_pcap_kd_zg)
```

## Model: All Years
```{r}
model1 <- lm(gdp_pc_g ~ year, data = data_filtered)
summary(model1)
```

## Identify Structural Breaks
```{r}
break_test1 <- breakpoints(gdp_pc_g ~ year, data = data_filtered)
summary(break_test1)

# Extract break years
breaks <- break_test1$breakpoints
break_years <- data_filtered$year[breaks]
break_years
```

## Structural Breaks Plot
```{r}
plot_breaks <- ggplot(data_filtered, aes(x = year, y = gdp_pc_g)) +
  geom_line(color = "navy", linewidth = 1) +
  geom_vline(xintercept = break_years, linetype = "dashed", color = "red",
             linewidth = 0.8) +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     breaks = scales::pretty_breaks(n = 6)) +
  scale_x_continuous(breaks = seq(1960, 2021, by = 5)) +
  labs(y = "GDP per capita growth", x = "Years",
       title = paste0("Structural breaks in GDP (pc) growth in ", country)) +
  theme_minimal(base_size = 14)
plot_breaks
```

The algorithm identified two major structural breaks in *1975* and *1985*, which aligns with the drops in the GDP time series for the Philippines. Building on my observations from the prior questions, the 1975 break might relate to the Philippines’ transition from an agrarian to an industrial economy as well as external economic factors such as the oil price shocks and the global recession of the 1980s. The 1985 break may also relate to internal turmoil from the 1986 People Power Revolution that destabilized the Philippines' political economy. 

Although Questions 1 & 2 revealed overall patterns of quality of life improvements from increasing GDP per capita, life expectancy, and education in the past decades, these structural breaks suggest the role of domestic and external factors in suddenly halting, or advancing, a country’s growth trajectory. 

# Question 5: Structural transformation comparison with other countries (10 points)

```{r}
# Add log of GDP per Capita
data$log_gdp_pc <- log(data$wdi_ny_gdp_pcap_cd)

# Add dummy column for the chosen country
data <- data %>%
  mutate(dummy_chosen_country = ifelse(wb_countryname == country, 1, 0))

# I am using 1960 as it is the first year for Philippines
data_filtered_1960 <- data %>%
  filter(year == 1960) %>%
  filter(!is.na(qog_wdi_popurb) & !is.na(wdi_ny_gdp_pcap_cd))

data_filtered_2021 <- data %>%
  filter(year == 2021) %>%
  filter(!is.na(qog_wdi_popurb) & !is.na(wdi_ny_gdp_pcap_cd))

#Plot Log(GDP) and Urban Population
ggplot(data_filtered_2021, aes(x = log_gdp_pc, y = qog_wdi_popurb)) +
  geom_point(color = "blue", size = 2, alpha = 0.7) +  # Scatter plot points
  geom_point(
    data = data_filtered_2021[data_filtered_2021$dummy_chosen_country == 1, ],
    aes(x = log_gdp_pc, y = qog_wdi_popurb),
    color = "yellow",
    size = 3
  ) +
  geom_text_repel(aes(label = wb_countryname), size = 3) +  # Repelled country labels
  geom_smooth(method = "lm", color = "red", se = FALSE, linetype = "solid") +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     breaks = scales::pretty_breaks(n = 6)) +
  labs(
    title = "Relation between Log(GDP pc) and urbanization",
    y = "Urban population (% of total population)",
    x = "Log(GDP per capita)"
  ) +
  theme_minimal(base_size = 14) +  # Minimal theme for a clean look
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks = element_line(color = "black", linewidth = 0.6),
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank()   # Remove minor grid lines
  )

```

The scatter plot reveals that higher GDP per capita is associated with a higher urban population. However, the Philippines (yellow) falls under the line of best fit, suggesting that it is performing *worse than expected*—its urbanization rate is lower than its GDP per capita predicted. However, the surrounding clusters of dots suggest that the Philippines is not the only country in this position—I added labels to my graph to identify that Bhutan, Belize, and Egypt are also nearby. On either side of the line, Burundi has the greatest extreme of low GDP per capita and urban population while Singapore maintains the highest GDP per capita and urban population. 

Although the previous questions revealed growing income, industry, and productivity levels, the Philippines’ lower urbanization rate may be due to policies or continued importance on agriculture and rural development. As we discussed in the TA session, this relationship between GDP per capita and urban population may conceal an omitted variable—further analysis might investigate what other factors hinder/advance urbanization besides GDP per capita. 

# Question 6: Comparative Trends in Structural Transformation (10 points)
```{r}
ggplot() +
  # Highlight chosen country in 1960 (red point)
  geom_point(
    data = data_filtered_1960[data_filtered_1960$dummy_chosen_country == 1, ],
    aes(x = log_gdp_pc, y = qog_wdi_popurb),
    color = "red",
    size = 3
  ) +
  # Highlight chosen country in 2021 (blue point)
  geom_point(
    data = data_filtered_2021[data_filtered_2021$dummy_chosen_country == 1, ],
    aes(x = log_gdp_pc, y = qog_wdi_popurb),
    color = "blue",
    size = 3
  ) +
  # Add arrow connecting 1960 and 2021 points
  geom_segment(
    data = merge(
      data_filtered_1960[data_filtered_1960$dummy_chosen_country == 1, ],
      data_filtered_2021[data_filtered_2021$dummy_chosen_country == 1, ],
      by = "dummy_chosen_country"
    ),
    aes(
      x = log_gdp_pc.x, y = qog_wdi_popurb.x,
      xend = log_gdp_pc.y, yend = qog_wdi_popurb.y
    ),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black",
    linewidth = 0.8
  ) +
  # Polynomial regression for 1988 (red curve)
  geom_smooth(
    data = data_filtered_1960,
    aes(x = log_gdp_pc, y = qog_wdi_popurb),
    method = "lm",
    formula = y ~ poly(x, 2),
    color = "red",
    se = FALSE,
    linetype = "solid"
  ) +
  # Polynomial regression for 2021 (blue curve)
  geom_smooth(
    data = data_filtered_2021,
    aes(x = log_gdp_pc, y = qog_wdi_popurb),
    method = "lm",
    formula = y ~ poly(x, 2),
    color = "blue",
    se = FALSE,
    linetype = "solid"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     breaks = scales::pretty_breaks(n = 6)) +
  # Axis labels
  labs(
    title = "Relation between Log(GDP pc) and urbanization",
    subtitle = "Red = 1960, Blue = 2021",
    y = "Urban Population (% of total population)",
    x = "Log(GDP per capita)"
  ) +
  # Minimal theme
  theme_minimal(base_size = 14) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks = element_line(color = "black", linewidth = 0.6),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

In 1960 (the first year GDP per capita data was available for the Philippines), the Philippines was below the urban population-GDP per capita curve, suggesting its urbanization levels were *lower* than expected. Its position in the middle of the red line further suggests its average performance globally. 

In 2021, the Philippines was similarly *below* the curve, suggesting its urban population levels were still *lower* than expected for its GDP per capita. However, its position relative to other countries also deteriorated, as the Philippines falls on the lower half of the blue line, part of the bottom half of countries for urban population and GDP per capita. 

Compared to the global trends, these curves reveal that the Philippines' urbanization rate lagged behind other countries, its gap between actual and predicted urban population widening between 1960 and 2021. While its GDP per capita did better, the Philippines underperformed in urban population growth. 


# Question 7: Conclusion (30 points)

This first cut of data revealed positive patterns for growth in the Philippines including its (1) transition away from an agrarian and toward a services-dominated economy; (2) growing population with declining mortality rates and longer life expectancy; (3) improvements in relative productivity across sectors and rising GDP per capita. However, its structural breaks reveal certain susceptibility to internal and external turmoil, such as domestic rebellion and global financial crisis. Additionally, the Philippines’ urban population is lower than predicted. 

Compared to other countries, the Philippines may have unique growth opportunities given its expanding industry, population, and productivity, prompting the central growth question: *How can the Philippines leverage its industry, population, and productivity growth; expand its urban population; and increase resilience to internal and external shocks?*

---
